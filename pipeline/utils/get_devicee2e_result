#!/bin/bash
set -x 

devicee2e_test_name=$1

time="date"
current_time=$(eval $time)

## Check the test status & result from the litmus result custom resource

testStatus=$(kubectl get e2eresult ${devicee2e_test_name} --no-headers -o custom-columns=:spec.testStatus.phase) && \
testResult=$(kubectl get e2eresult ${devicee2e_test_name} --no-headers -o custom-columns=:spec.testStatus.result); retcode=$?
bash pipeline/utils/error_handler ${retcode} msg="Unable to find device-e2e result custom resource, exiting" action="exit"

if [[ ${testStatus} == "completed" ]]; then
  if [[ ${testResult} == "Pass" ]]; then
    bash pipeline/utils/device-e2e-cr jobname:$2 jobphase:Completed end_time:"$current_time" test_result:Pass
    echo "TEST: PASS"
  else
    bash pipeline/utils/device-e2e-cr jobname:$2 jobphase:Completed end_time:"$current_time" test_result:Fail
    echo "TEST: FAILED"; exit 1
  fi
else
  echo "Test Execution was aborted"; exit 1
fi